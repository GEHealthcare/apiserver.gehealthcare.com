<html>

<head>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS"
	 crossorigin="anonymous">
	<script src="./config.js"></script>
	<script>
		
		// (Important) login function contains the step wise js code to oauth2 login process 
		function login() {
			stepInProgress('step1');
			/*	STEP 1 : Get metadata
				Description: 
				Get metadata of the FHIR server to check the conformance resource for the authorize and 
				token generation URLs. 
			*/
			getAjaxCall(config.fhir_base_url+'/metadata?_format=json').then((conformance) => {
				stepInProgress('step2');
				/* STEP 2 : Extract token URL and authorize URL from metadata.
				   Description: 
				   a.Extract list of security extensions namely 'token' and 'authorize'
				     from metadata. 
				   b.Authorize URL is used to get the 'code' from the FHIR server by redirecting to 
				     it and logging in the user. This generated code is then used for getting token from 
				     tokenURL using a POST request.
				*/
				let extensions = (JSON.parse(conformance).rest[0].security.extension[0].extension);
				let tokenURL, authorizeURL;
				for (let i = 0; i < extensions.length; i++) {
					if (extensions[i].url === 'token')
						tokenURL = extensions[i].valueUri;
					if (extensions[i].url === 'authorize')
						authorizeURL = extensions[i].valueUri;
				}
				if (!(tokenURL && authorizeURL)) {
					alert('Not able to retrive token or authorize url.');
				} else {
				/*   STEP 3 : Redirect to authorize URL for getting code.
					 Description:
					 a.This code will be made available by FHIR server on the redirect URL
					   using POST request. Authorize URL is appended with all required data
					   like scope, client ID etc.
						 
					Note : Below Client id and secret is generated by registering the app in
						   centricity developer portal(https://mydata.gehealthcare.com).
					       In this request client secret is not requried. Client secret is needed in token generation.
					
					Note : For Step 4 refer redirect.html
						   */
					let redirect = authorizeURL + '?client_id=' + config.clientID + '&state=abc123&redirect_uri=' + config.redirect_url + '&response_type=code%20id_token&response_mode=form_post&aud=https://apisandbox.gehealthcare.com:9443/demoAPIServer/fhir' + '&scope=openid%20profile%20user%2FAllergyIntolerance.read%20user%2FPatient.read%20user%2FMedicationStatement.read%20user%2FCondition.read%20user%2FPractitioner.read%20user%2FBinary.read%20user%2FMedicationOrder.read%20user%2FBasicAdvanceDirective.read%20user%2FCoverage.read%20user%2FDocumentReference.read%20user%2FObservation.read%20user%2FFamilyMemberHistory.read%20user%2FProcedure.read%20user%2FAppointment.read%20user%2FSchedule.read%20user%2FSlot.read'
					window.location.href = redirect;
				}
			});
		}

		// function to send simple get request in javascript and return a promise
		function getAjaxCall(url) {
			// return a new promise. 
			return new Promise(function (resolve, reject) {
				// do the usual XHR stuff for a get request
				var req = new XMLHttpRequest();
				req.open('get', url);
				req.onload = function () {
					if (req.status == 200) {
						setTimeout(function () {
							// adding a delay of 2 sec for showing stepwise progress.
							resolve(req.response);
						}, 2000);
					} else {
						reject(Error(req.statusText));
					}
				};
				// handle network errors 
				req.onerror = function () {
					reject(Error("Network Error"));
				}; // make the request 
				req.send();
			});
		};

		// function to show currently executing step.
		function stepInProgress( step ) {
			document.getElementById(step).style.display = 'block';
		}
	</script>
</head>

<body>

	<div class="container">
		<div class="jumbotron mt-3">
			<h1>Centricity Token Generation sample code</h1>
			<p class="lead">This sample code contains basic flow of generating token after you have registered your app on centricity developer portal.</p>
			<button type="button" class="btn btn-primary" onclick="login()">Login</button>
		</div>
		<div id="step1" class="alert alert-info" style="display:none;" role="alert">
			Getting metadata from cpsapisandbox FHIR server.
		</div>
		<div id="step2" class="alert alert-info" style="display:none;" role="alert">
			Recieved metadata from cpsapisandbox FHIR server.
		</div>

	</div>
</body>

</html>